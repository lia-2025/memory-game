<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç¥çµŒè¡°å¼±ã‚²ãƒ¼ãƒ </title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/p5.js/1.4.0/p5.min.js"></script>
</head>
<body>
    <script>
        let rows = 4, cols = 4; // 4x4ã®ã‚«ãƒ¼ãƒ‰
        let cardSize = 150;
        let cards = [];
        let flippedCards = [];
        let matchedPairs = 0;
        let images = {};
        let pairs = [["1.png", "A.png"], ["2.png", "B.png"], ["3.png", "C.png"], ["4.png", "D.png"],
                     ["5.png", "E.png"], ["6.png", "F.png"], ["7.png", "G.png"], ["8.png", "H.png"]];
        let startTime, clearTime, gameOver; // ã‚¯ãƒªã‚¢æ™‚é–“ã¨ã‚²ãƒ¼ãƒ çŠ¶æ…‹
        let clearTimeText = ""; // ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ è¡¨ç¤ºç”¨ãƒ†ã‚­ã‚¹ãƒˆ
        let replayButton, screenshotButton; // ãƒªãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ & ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒœã‚¿ãƒ³

        function preload() {
            images["back"] = loadImage("cards/back.png"); // è£é¢
            for (let pair of pairs) {
                images[pair[0]] = loadImage("cards/" + pair[0]);
                images[pair[1]] = loadImage("cards/" + pair[1]);
            }
        }

        function setup() {
            createCanvas(cols * cardSize, rows * cardSize + 150); // ä¸‹ã«ã‚¹ãƒšãƒ¼ã‚¹è¿½åŠ 
            initializeGame();
        }

        function initializeGame() {
            cards = [];
            flippedCards = [];
            matchedPairs = 0;
            clearTimeText = "";
            gameOver = false;
            
            let tempCards = [];
            for (let pair of pairs) {
                tempCards.push({ id: pair[0], img: images[pair[0]], pair: pair[1] });
                tempCards.push({ id: pair[1], img: images[pair[1]], pair: pair[0] });
            }
            shuffle(tempCards, true);
            for (let i = 0; i < rows; i++) {
                for (let j = 0; j < cols; j++) {
                    let index = i * cols + j;
                    cards.push({ x: j * cardSize, y: i * cardSize, ...tempCards[index], flipped: false, matched: false });
                }
            }

            startTime = millis(); // ğŸ¯ ã‚²ãƒ¼ãƒ é–‹å§‹æ™‚é–“ã‚’è¨˜éŒ²
            clearTime = null; // ã‚¯ãƒªã‚¢æ™‚é–“ã‚’ãƒªã‚»ãƒƒãƒˆ

            // ğŸ¯ ãƒªãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ã®ä½œæˆï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰
            if (replayButton) replayButton.remove();
            replayButton = createButton("ğŸ”„ ã‚‚ã†ä¸€åº¦ãƒ—ãƒ¬ã‚¤");
            replayButton.position(width / 2 - 60, height - 60); // ä¸Šå´ã«é…ç½®
            replayButton.mousePressed(initializeGame);
            replayButton.hide();

            // ğŸ¯ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒœã‚¿ãƒ³ã®ä½œæˆï¼ˆæœ€åˆã¯éè¡¨ç¤ºï¼‰
            if (screenshotButton) screenshotButton.remove();
            screenshotButton = createButton("ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã‚‹");
            screenshotButton.position(width / 2 - 80, height - 30); // ä¸‹å´ã«é…ç½®
            screenshotButton.mousePressed(takeScreenshot);
            screenshotButton.hide();
        }

        function draw() {
            background(255);
            for (let card of cards) {
                if (card.flipped || card.matched) {
                    image(card.img, card.x, card.y, cardSize, cardSize);
                } else {
                    image(images["back"], card.x, card.y, cardSize, cardSize);
                }
            }

            // ğŸ¯ ã‚¯ãƒªã‚¢å‰ãªã‚‰ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã§çµŒéæ™‚é–“ã‚’æ›´æ–°
            let elapsedTime = gameOver ? clearTime : ((millis() - startTime) / 1000).toFixed(2);

            fill(0);
            textSize(24);
            textAlign(CENTER, CENTER);
            text(`â±ï¸ çµŒéæ™‚é–“: ${elapsedTime}ç§’`, width / 2, height - 110); // ã‚¯ãƒªã‚¢æ™‚é–“ã‚’ä¸Šã®æ–¹ã«é…ç½®
            text(clearTimeText, width / 2, height - 80); // ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ ã®ãƒ†ã‚­ã‚¹ãƒˆ
        }

        function mousePressed() {
            if (flippedCards.length >= 2 || gameOver) return; // 2æšä»¥ä¸Šã¯ã‚ãã‚Œãªã„ï¼†ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢å¾Œã¯ã‚¯ãƒªãƒƒã‚¯ç„¡åŠ¹

            for (let card of cards) {
                if (!card.flipped && !card.matched && mouseX > card.x && mouseX < card.x + cardSize &&
                    mouseY > card.y && mouseY < card.y + cardSize) {
                    card.flipped = true;
                    flippedCards.push(card);
                    
                    if (flippedCards.length === 2) {
                        setTimeout(checkMatch, 1000);
                    }
                    break;
                }
            }
        }

        function checkMatch() {
            let [card1, card2] = flippedCards;
            if (card1.pair === card2.id) {
                card1.matched = true;
                card2.matched = true;
                matchedPairs++;
                if (matchedPairs === pairs.length) {
                    clearTime = ((millis() - startTime) / 1000).toFixed(2); // ğŸ¯ ã‚¯ãƒªã‚¢æ™‚é–“ã‚’è¨˜éŒ²
                    clearTimeText = `ğŸ‰ ã‚¯ãƒªã‚¢ã‚¿ã‚¤ãƒ : ${clearTime}ç§’`;
                    gameOver = true; // ğŸ¯ ã‚²ãƒ¼ãƒ ã‚¯ãƒªã‚¢æ™‚ã«æ™‚é–“ã®æ›´æ–°ã‚’æ­¢ã‚ã‚‹

                    replayButton.show(); // ã‚¯ãƒªã‚¢å¾Œã«ãƒªãƒ—ãƒ¬ã‚¤ãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                    screenshotButton.show(); // ã‚¯ãƒªã‚¢å¾Œã«ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆãƒœã‚¿ãƒ³ã‚’è¡¨ç¤º
                }
            } else {
                card1.flipped = false;
                card2.flipped = false;
            }
            flippedCards = [];
        }

        // ğŸ“¸ ã‚¹ã‚¯ãƒªãƒ¼ãƒ³ã‚·ãƒ§ãƒƒãƒˆã‚’æ’®ã£ã¦ä¿å­˜ã™ã‚‹é–¢æ•°ï¼ˆãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ãŸã¨ãã«å®Ÿè¡Œï¼‰
        function takeScreenshot() {
            let filename = `memory_game_${clearTime.replace(".", "_")}sec.png`; // ä¾‹: memory_game_15_32sec.png
            saveCanvas(filename, 'png'); // p5.js ã® `saveCanvas()` ã‚’ä½¿ã£ã¦ä¿å­˜
        }
    </script>
</body>
</html>
